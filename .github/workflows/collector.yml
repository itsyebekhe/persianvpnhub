name: PersianVPNHub Bot

on:
  schedule:
    - cron: '*/30 * * * *' # Run every 30 minutes
  workflow_dispatch:      # Allow manual run

# --- ADDED THIS SECTION ---
concurrency:
  # This creates a unique group for this workflow on this branch
  group: ${{ github.workflow }}-${{ github.ref }}
  # false = If a job is running, the new one waits in a queue until the first finishes.
  # true = If a job is running, GitHub kills it to start the new one (BAD for this bot).
  cancel-in-progress: false
# --------------------------

permissions:
  contents: write

jobs:
  collect-and-post:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code (Main)
      uses: actions/checkout@v3
      with:
        fetch-depth: 0 

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Dependencies
      run: |
        pip install telethon aiohttp geoip2 python-socks

    - name: Run Collector Script
      env:
        API_ID: ${{ secrets.API_ID }}
        API_HASH: ${{ secrets.API_HASH }}
        SESSION_STRING: ${{ secrets.SESSION_STRING }}
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        DESTINATION_ID: ${{ secrets.DESTINATION_ID }}
      run: python bot.py

    - name: Configure Git
      run: |
        git config --global user.name "PersianVPNHub-Bot"
        git config --global user.email "bot@persianvpnhub.local"

    # --- PART 1: Save Bot Memory to Main ---
    - name: Commit State (History & Stats) to Main
      run: |
        git add history.json stats.json
        
        if ! git diff --cached --quiet; then
          git commit -m "Update Bot State [skip ci]"
          git push origin main
        else
          echo "No changes to history or stats."
        fi

    # --- PART 2: Publish Subscriptions to Export ---
    - name: Publish Subscriptions to Export Branch
      run: |
        mkdir -p /tmp/subs_output
        mv normal /tmp/subs_output/ 2>/dev/null || true
        mv base64 /tmp/subs_output/ 2>/dev/null || true

        if git show-ref --verify --quiet refs/remotes/origin/export; then
          git checkout export
          git pull origin export
        else
          git checkout --orphan export
          git rm -rf .
        fi

        mv /tmp/subs_output/* .

        git add normal base64
        
        if ! git diff --cached --quiet; then
          git commit -m "Update Subscription Files [skip ci]"
          git push origin export
        else
          echo "No changes to subscription files."
        fi
